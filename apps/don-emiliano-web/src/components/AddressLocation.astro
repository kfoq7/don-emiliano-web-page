---
import MapPicker from './MapPicker.astro'
---

<section class="min-h-screen flex items-center">
  <div class="w-full max-w-4xl mx-auto p-4">
    <div class="mb-4 relative z-50">
      <label for="address-input" class="block text-sm font-medium mb-2"> Dirección </label>
      <input
        type="text"
        id="address-input"
        placeholder="Ingrese la dirección..."
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        autocomplete="off"
      />
      <div
        id="autocomplete-results"
        class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden"
      >
      </div>
    </div>

    <MapPicker />
  </div>
</section>

<script>
  import { location } from '@/stores/location'

  const addressInput = document.getElementById('address-input') as HTMLInputElement
  const autocompleteResults = document.getElementById('autocomplete-results') as HTMLDivElement

  let debounceTimeout: NodeJS.Timeout | null = null

  // Subscribe to location store changes
  // locationStore.subscribe(state => {
  //   if (state.address && addressInput) {
  //     addressInput.value = state.address
  //   }
  // })

  async function searchAddress(address: string) {
    if (address.length < 3) {
      autocompleteResults.classList.add('hidden')
      return
    }

    if (debounceTimeout) {
      clearTimeout(debounceTimeout)
    }

    debounceTimeout = setTimeout(async () => {
      try {
        const query = encodeURIComponent(`${address}, Comas, Lima, Peru`)
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?q=${query}&bounded=1&viewbox=-77.08,-11.92,-77.02,-11.98&accept-language=es-PE&format=jsonv2&limit=5`,
        )

        const results = await response.json()

        if (results.length > 0) {
          autocompleteResults.innerHTML = results
            .map(
              (result: { display_name: string; lat: string; lon: string }) => `
            <div class="autocomplete-item p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0" data-lat="${result.lat}" data-lon="${result.lon}" data-address="${result.display_name}">
              ${result.display_name}
            </div>
          `,
            )
            .join('')

          autocompleteResults.classList.remove('hidden')

          // Add click event listeners to autocomplete items
          const items = autocompleteResults.querySelectorAll('.autocomplete-item')
          items.forEach(item => {
            item.addEventListener('click', () => {
              const resultItem = item as HTMLElement
              const lat = parseFloat(resultItem.dataset.lat || '0')
              const lng = parseFloat(resultItem.dataset.lon || '0')

              // Update the store with selected location
              location.set({
                lat,
                lng,
              })

              autocompleteResults.classList.add('hidden')
            })
          })
        } else {
          autocompleteResults.innerHTML =
            '<div class="p-3 text-gray-500">No se encontraron resultados</div>'
          autocompleteResults.classList.remove('hidden')
        }
      } catch (error) {
        console.error('Error fetching addresses:', error)
        autocompleteResults.innerHTML =
          '<div class="p-3 text-red-500">Error al buscar direcciones</div>'
        autocompleteResults.classList.remove('hidden')
      }
    }, 300)
  }

  addressInput.addEventListener('input', e => {
    const target = e.target as HTMLInputElement
    searchAddress(target.value)
  })

  // Hide autocomplete when clicking outside
  document.addEventListener('click', e => {
    if (
      !addressInput.contains(e.target as Node) &&
      !autocompleteResults.contains(e.target as Node)
    ) {
      autocompleteResults.classList.add('hidden')
    }
  })
</script>
